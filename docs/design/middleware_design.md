# Middleware Design 中间件设计

中间件设计是构建高效、可维护的Web应用程序的重要组成部分。

中间件可以在请求处理的不同阶段执行特定的功能，如认证、日志记录、错误处理等。本文档将介绍中间件的设计原则、常见类型以及实现示例。

## 文档更新记录

| Code | Module          | Date       | Author | PRI | Description                                |
|------|-----------------|------------|--------|-----|--------------------------------------------|
| 1    | base-middleware | 2025-06-21 | AEnjoy | P0  | 初始设计文档创建,提供`认证中间件`,`日志中间件`,`CORS中间件`等中间件设计 |

## 设计原则

1. **单一职责原则**：每个中间件应专注于一个特定的功能或任务，避免过多的职责混合。
2. **可重用性**：中间件应设计为可重用的组件，可以在不同的应用或服务中使用。
3. **可配置性**：中间件应支持配置选项，以便在不同环境或场景下进行调整。
4. **性能优化**：中间件应尽量减少对请求处理的延迟，优化性能。
5. **错误处理**：中间件应具备良好的错误处理机制，能够捕获和处理异常情况。
6. **日志记录**：中间件应支持日志记录功能，以便于调试和监控。

## 中间件列表

1. P0-**认证中间件**：
   1. 处理用户认证和授权，验证JWT令牌的有效性。
2. P0-**日志中间件**：
   1. 记录请求和响应的日志信息，包括请求路径、方法、状态码等。
3. P0-**CORS中间件**：
   1. 处理跨域资源共享（CORS）请求，允许特定的域名访问API。
4. P1-**错误处理中间件**：
   1. 捕获和处理应用中的错误，返回统一的错误响应格式。
5. P1-**性能监控中间件**：
   1. 记录请求处理的时间，监控应用性能。
6. P2-**请求限流中间件**：
   1. 限制特定IP或用户的请求频率，防止滥用。
7. P2-**请求缓存中间件**：
   1. 缓存常用的请求结果，减少对数据库的访问。
8. P2-**请求追踪中间件**：
   1. 提供请求追踪功能，记录请求的处理流程和依赖关系。

## 中间件实现示例

```go
func Logger() gin.HandlerFunc {
	return gin.LoggerWithFormatter(func(param gin.LogFormatterParams) string {
		return fmt.Sprintf("%s - [%s] \"%s %s %s %d %s \"%s\" %s\"\n",
			param.ClientIP,
			param.TimeStamp.Format(time.RFC1123),
			param.Method,
			param.Path,
			param.Request.Proto,
			param.StatusCode,
			param.Latency,
			param.Request.UserAgent(),
			param.ErrorMessage,
		)
	})
}

func Router(){
	router := gin.Default()
	router.Use(Logger())
}
```

## 测试Case

1. **认证中间件测试**：验证JWT令牌的有效性，确保未授权的请求被拒绝。
2. **日志中间件测试**：检查日志记录是否正确，包括请求路径、方法、状态码等信息。
3. **CORS中间件测试**：验证跨域请求是否被正确处理，确保允许的域名可以访问API。
